language: minimal

services:
  - docker

env:
  global:
    - IMAGE_NAME=liquibase-pro:4.32.0
    - DB_NAME=liquibasedb
    - DB_USER=liquibase
    - DB_PASS=secret
    - DB_PORT=5432
    - DB_CONTAINER=pgdb
    - LIQUIBASE_LICENSE_KEY=secure_value_set_in_UI

before_install:
  - echo "[+] Building Liquibase Docker image from Dockerfile..."
  - docker build -t $IMAGE_NAME .

before_script:
  - echo "[+] Creating Docker network..."
  - docker network create liquibase-net

  - echo "[+] Starting PostgreSQL container..."
  - docker run -d --name $DB_CONTAINER --network liquibase-net -e POSTGRES_DB=$DB_NAME -e POSTGRES_USER=$DB_USER -e POSTGRES_PASSWORD=$DB_PASS -p $DB_PORT:5432 postgres:14

  - echo "[+] Waiting for PostgreSQL to be ready..."
  - until docker exec $DB_CONTAINER pg_isready -U $DB_USER; do sleep 2; done

script:
  - echo "[+] Running Liquibase Pro update..."
  - docker run --rm --network liquibase-net -e LIQUIBASE_LICENSE_KEY=$LIQUIBASE_LICENSE_KEY $IMAGE_NAME update

